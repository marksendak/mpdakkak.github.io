<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Hierarchical Condition Categories (HCC)</title>

<script src="cms_hcc_files/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="cms_hcc_files/bootstrap-3.3.1/css/flatly.min.css" rel="stylesheet" />
<script src="cms_hcc_files/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="cms_hcc_files/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="cms_hcc_files/bootstrap-3.3.1/shim/respond.min.js"></script>
<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 50px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h2 {
  padding-top: 55px;
  margin-top: -55px;
}
.section h3 {
  padding-top: 55px;
  margin-top: -55px;
}
/* don't use link color in navbar */
.dropdown-menu>li>a {
  color: black;
}

</style>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="cms_hcc_files/highlight/textmate.css"
      type="text/css" />
<script src="cms_hcc_files/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Healthy Data Science</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="authoring" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Electronic Health Record <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
             <li class="dropdown-header">Basics</li>
             <li><a href="working_with_dates.html">Working with Dates</a></li>
             <li><a href="fast_append.html">Fast Append</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Diagnoses</li>
             <li><a href="ahrq_ccs_icd.html">Clinical Classification Software</a></li>
             <li><a href="cms_hcc.html">Hierarchical Condition Categories</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Procedures</li>
             <li><a href="ahrq_ccs_cpt.html">Clinical Classification Software</a></li>
          </ul>
        </li>
<!--        
        <li class="dropdown">
          <a href="formats" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Medicare Claims <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
             <li class="dropdown-header">Documents</li>
             <li><a href="html_document_format.html">HTML</a></li>
             <li><a href="pdf_document_format.html">PDF</a></li>
             <li><a href="word_document_format.html">Word</a></li>
             <li><a href="markdown_document_format.html">Markdown</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Presentations</li>
             <li><a href="ioslides_presentation_format.html">ioslides</a></li>
             <li><a href="slidy_presentation_format.html">Slidy</a></li>
             <li><a href="beamer_presentation_format.html">Beamer</a></li>
             <li class="divider"></li>
             <li class="dropdown-header">Other</li>
             <li><a href="package_vignette_format.html">Package Vignette</a></li>
             <li><a href="tufte_handout_format.html">Tufte Handout</a></li>
             <li class="divider"></li>
             <li><a href="r_notebook_format.html">R Notebooks</a></li>
          </ul>
        </li>
         <li class="dropdown">
          <a href="developer" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Public Data Sets <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
             <li><a href="developer_html_widgets.html">HTML Widgets</a></li>
             <li class="divider"></li>
             <li><a href="developer_parameterized_reports.html">Parameterized Reports</a></li>
             <li class="divider"></li>
             <li><a href="developer_document_templates.html">Document Templates</a></li>
             <li><a href="developer_custom_formats.html">Creating New Formats</a></li>
             <li class="divider"></li>
             <li><a href="https://github.com/rstudio/rmarkdown">R Markdown on GitHub</a></li>
          </ul>
        </li>
//-->
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">
<h1 class="title">Hierarchical Condition Categories (HCC)</h1>
</div>


<div id="intro" class="section level2">
<h2>Intro</h2>
<p>The Centers for Medicare &amp; Medicaid Services (CMS) hierarchical condition categories (HCC) model, implemented in 2004, is a risk-adjustment model used to adjust Medicare payments to health care plans for the health expenditure risk of their enrollees. It’s intended use is to pay insurance plans appropriately for their expected relative costs. For example, health plans that care for overwhelmingly healthy populations are paid less than those that care for much sicker populations.</p>
<p>The full model includes variable interactions, demographics (e.g., age, gender), and indicator variables for Medicaid enrollment and disabled status. However, this post will only cover using the HCC model to cluster diagnosis codes into meaningful categories. We’ll implement HCCs for ICD 9 codes using the 2014 model, but once ICD 10 is implemented in my environment, I’ll update the post.</p>
<p>To see the different versions of the model, please visit:<br />- <a href="https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors-Items/Risk2014.html">2014 Model</a><br />- <a href="https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors-Items/Risk2015.html">2015 Model</a><br />- <a href="https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors-Items/IDC10Mappings.html">ICD 10 Mapping</a></p>
</div>
<div id="classification-system" class="section level2">
<h2>Classification System</h2>
<p>The HCC diagnostic classification system has four components:<br />- Classify over 14,000 ICD 9 diagnosis codes into 805 diagnostic groups, which represent a well-specified medical condition.<br />- Diagnosis groups are further aggregated into 189 condition categories, which describe a broader set of diseases. Diseases within a condition category are related clinically and with respect to cost.<br />- Only use the subset of 189 condition categories that best predict Medicare Part A (inpatient) and Part B (outpatient) medical expenditures. The most recent version (version 22) of the CMS HCC model includes 79 of the disease categories, excluding those that contain diagnoses that are vague/nonspecific (e.g., symptoms), discretionary in medical treatment or coding (e.g., osteoarthritis), not medically significant (e.g., muscle strain), or transitory/definitively treated (e.g., appendicitis). The model also excludes categories that do not empirically add to costs, as well as categories that are fully defined by the presence of procedures or durable medical equipment. This focuses the model on medical problems that are present, rather than services offered.<br />- Hierarchies are imposed among related condition categories, so that a person is coded for only the most severe manifestation among related diseases. For example, there are four condition categories related to Ischemic Heart Disease; acute myocardial infarction (81), unstable angina &amp; other acute ischemic heart disease (82), angina pectoris (83), and coronary atherosclerosis (84). A patient with an ICD 9 code in condition category 81 is excluded from being coded in categories 82, 83, or 84, even if diagnosis codes in those categories are present.</p>
</div>
<div id="what-youll-need" class="section level2">
<h2>What you’ll need</h2>
<ol style="list-style-type: decimal">
<li>Extract a list of patient ICD 9 diagnosis codes from your EHR. The code below assumes this file has 4 columns (Patient_Identifier, Encounter_Identifier, ICD_Diagnosis_Code, and Diagnosis_Date). To identify diagnoses, you’ll have to decide on a window of time to look at. For most cases, we look at two years worth of ICD 9 codes, but you may be interested in smaller or larger time periods. In the code below, this data set is called ‘ICD9_Codes’.<br /></li>
<li>Download the <a href="https://www.cms.gov/Medicare/Health-Plans/MedicareAdvtgSpecRateStats/Risk-Adjustors-Items/Risk2014.html">2014-Final Model</a> and unzip the “CMS-HCC software V2213.79.L2” folder, which contains all the files to implement version 22 of the HCC model.<br /></li>
<li>Set the “hcc” directory to the file path for the “CMS-HCC software V2213.79.L2” folder and the “ehr” directory to the file path containing your ICD 9 diagnosis codes.</li>
</ol>
</div>
<div id="packages" class="section level2">
<h2>Packages</h2>
<p>Load data.table, lubridate, and stringr:</p>
<pre class="r"><code>library(data.table)
library(lubridate)
library(stringr)</code></pre>
</div>
<div id="step-1-build-hcc-label-table" class="section level2">
<h2>Step 1: Build HCC label table</h2>
<p>The function below converts the text in the SAS file V22H79L1.txt into a table with two columns. The first column is the HCC category and the second column is the HCC category label.</p>
<pre class="r"><code>HCC_Labels &lt;- function(hcc){
    ## Set working directory
    setwd(hcc)
    
    ## Load packages
    require(data.table)
    require(stringr)
    
    ## Read lines of SAS file
    labels &lt;- readLines(&quot;V22H79L1.TXT&quot;)[9:89]
    
    ## Combine lines that refer to same HCC
    labels &lt;- paste(labels, collapse = &quot; &quot;)
    labels &lt;- unlist(tstrsplit(labels, &quot; HCC&quot;))
    
    ## Convert to data table
    labels &lt;- as.data.table(labels)

    ## Change column name
    setnames(labels, &quot;labels&quot;, &quot;HCC&quot;)
    
    ## Separate each line into two variables
    labels[, c(&quot;HCC&quot;,&quot;HCC_Label&quot;) := tstrsplit(HCC, &quot;=&quot;, fixed = TRUE)]

    ## Remove white space
    Trim &lt;- function(x){str_trim(x, side = &quot;both&quot;)}
    labels &lt;- labels[, lapply(.SD, Trim)]
    
    ## Remove quotations from label
    labels[, HCC_Label := gsub(&#39;&quot;&#39;, &quot;&quot;, HCC_Label)]
    
    ## Remove letters from HCC variable
    labels[, HCC := as.integer(gsub(&quot;HCC&quot;, &quot;&quot;, HCC))]
    
    ## Return label table
    return(labels)
}</code></pre>
<p>Run the function above and assign the output to a table called labels:</p>
<pre class="r"><code>labels &lt;- HCC_Labels(hcc)</code></pre>
</div>
<div id="step-2-classify-icd-9-codes-into-condition-categories" class="section level2">
<h2>Step 2: Classify ICD 9 Codes Into Condition Categories</h2>
<p>This step uses ICD9 codes extracted from your EHR and the F2213L2P.TXT crosswalk file to group ICD 9 codes into the 79 relevant condition categories included in version 22 of the CMS HCC model.</p>
<pre class="r"><code>Assign_CCs &lt;- function(ICD9_Codes, hcc){
    ## Load packages
    require(data.table)
    require(lubridate)
    
    ## Read in crosswalk
    setwd(hcc)
    crosswalk &lt;- as.data.table(read.table(&quot;F2213L2P.TXT&quot;))
    
    ########## Clean ICD 9 codes
    ## Fix column names of ICD9 codes
    if(names(ICD9_Codes) != c(&quot;Patient_Identifier&quot;, &quot;Encounter_Identifier&quot;, &quot;ICD_Diagnosis_Code&quot;, &quot;Diagnosis_Date&quot;))
        setnames(ICD9_Codes, names(ICD9_Codes), c(&quot;Patient_Identifier&quot;, &quot;Encounter_Identifier&quot;, &quot;ICD_Diagnosis_Code&quot;, &quot;Diagnosis_Date&quot;))
    
    ## Fix dates on ICD 9 codes
    if(class(ICD9_Codes$Diagnosis_Date) != &quot;Date&quot;)
        ICD9_Codes[, c(&quot;Diagnosis_Date&quot;, &quot;Time&quot;, &quot;AM_PM&quot;) := tstrsplit(Diagnosis_Date, &quot; &quot;, fixed = TRUE)][, c(&quot;Time&quot;, &quot;AM_PM&quot;) := NULL][, Diagnosis_Date := as.Date(fast_strptime(Diagnosis_Date, format = &quot;%m/%d/%Y&quot;))]     
    
    ## Remove periods
    if(sum(grepl(&quot;.&quot;, ICD9_Codes$ICD_Diagnosis_Code)) != 0)
        ICD9_Codes[, ICD_Diagnosis_Code := gsub(&quot;\\.&quot;, &quot;&quot;, ICD_Diagnosis_Code)]
    
    ########## Clean crosswalk
    ## Change names
    setnames(crosswalk, names(crosswalk), c(&quot;ICD_Diagnosis_Code&quot;, &quot;HCC&quot;))
    
    ########## Merge ICD 9 codes with crosswalk
    ICD9_Codes &lt;- merge(ICD9_Codes, crosswalk, by = &quot;ICD_Diagnosis_Code&quot;)

    ## Return ICD 9 codes
    return(ICD9_Codes)
}</code></pre>
<p>The merge above is an inner join that assigns ICD 9 codes to condition categories. Note that many ICD 9 codes you extract from the EHR will be dropped, because they do not correspond to condition categories that are relevant for the model. For example, when I ran the function above on a sample of ~840,000 ICD 9 codes extracted from the EHR, only ~135,000 are assigned to condition categories. This should emphasize that HCCs should only be used to identify the prevalence of chronic conditions that are defined in the model.</p>
<p>Run the function above and pass the result to a table called ICD9s_CCs:</p>
<pre class="r"><code>ICD9s_CCs &lt;- Assign_HCCs(ICD9_Codes, hcc)</code></pre>
</div>
<div id="step-3-identify-condition-categories-across-population" class="section level2">
<h2>Step 3: Identify Condition Categories Across Population</h2>
<p>Now that the ICD 9 codes are classified by patient and by condition category, you can calculate the presence of the 79 condition categories for each patient:</p>
<pre class="r"><code>Collapse_CCs &lt;- function(ICD9s_CCs, labels){
    ## Load data.table
    require(data.table)
    
    ## Count diagnosis codes for each patient in each category
    cc_by_patient &lt;- ICD9s_CCs[, .(Freq = .N), by = c(&quot;Patient_Identifier&quot;, &quot;HCC&quot;)]
    
    ## Only keep categories where patients have more than one diagnosis code
    cc_by_patient &lt;- cc_by_patient[Freq &gt;= 2]
    
    ## Only keep the columns for patient and HCC
    cc_by_patient &lt;- cc_by_patient[, .(Patient_Identifier, HCC)]
    
    ########## Convert long and skinny table to long and fat
    ## Identify all the HCCs for which you have to build out dummy variables
    dummies &lt;- as.character(labels$HCC)
    
    ## Build out dummy variables for each category
    cc_by_patient[,(paste(&quot;HCC&quot;, dummies, sep = &quot;&quot;)):=lapply(dummies,function(x) as.numeric(HCC==as.character(x)))]
    
    ## Drop HCC variable
    cc_by_patient[, HCC := NULL]
    
    ####### Collapse data to 1 row per patient
    cc_by_patient &lt;- cc_by_patient[, lapply(.SD, max), by = Patient_Identifier]
    
    ## Return data for all 79 CCs for each patient
    return(cc_by_patient)
}</code></pre>
<p>Note that the function above takes labels (the output of step 1) and ICD9s_CCs (the output of step 2) as inputs. In return, the function builds a wide table with one row for each patient and 80 columns. The first column is patient identifier and the following 79 columns are for each of the condition categories. A value of 1 indicates presence of a condition and a value of 0 indicates absence of a condition.</p>
<p>Run the function above and assign the output to Condition_Categories:</p>
<pre class="r"><code>Condition_Categories &lt;- Collapse_CCs(ICD9s_CCs, labels)</code></pre>
</div>
<div id="step-4-build-a-hierarchy-table" class="section level2">
<h2>Step 4: Build a Hierarchy Table</h2>
<p>So far, we have been working with condition categories, NOT hierarchical condition categories. In the table built above, Condition_Categories, it’s possible for patients to have “Diabetes without complication” as well as “Diabetes with chronic complications”. We’ll fix this issue by requiring patients to only have the most severe condition within a group of related conditions.</p>
<p>To determine the hierarchical structure of the condition categories, we’ll build a table from the V22H79H1.TXT file. The table will have three columns: Condition Name, HCC, and a list of HCCs to zero if a patient has a given HCC in the second column. For example, a patient with a value of 1 for HCC 8 (“Metastatic Cancer and Acute Leukemia”) has 0 values overwritten for HCC 9 (“Lung and Other Severe Cancers”), HCC 10 (“Lymphoma and Other Cancers”), HCC 11 (“Colorectal, Bladder, and Other Cancers”), and HCC 12 (“Breast, Prostate, and Other Cancers and Tumors”).</p>
<pre class="r"><code>HCC_Table &lt;- function(hcc){
    ## Load packages
    require(data.table)
    require(stringr)
    
    ## Load V22H79H1.txt
    setwd(hcc)
    Hierarchy &lt;- as.data.table(readLines(&quot;V22H79H1.txt&quot;)[28:58])
    
    ## Change name of first column
    setnames(Hierarchy, &quot;V1&quot;, &quot;Condition&quot;)
    
    ## Split out condition categories to zero
    Hierarchy[, c(&quot;Condition&quot;, &quot;HCC&quot;, &quot;To_Zero&quot;) := tstrsplit(Condition, &quot;%&quot;, fixed = TRUE)]
    
    ## Strip away extra characters in HCC variable
    Hierarchy[, HCC := gsub(&quot;=&quot;, &quot;HCC&quot;, str_extract(HCC, &quot;=[0-9]+&quot;))]
    
    ## Strip away extra characters in To_Zero variable
    Hierarchy[, To_Zero := gsub(&quot;STR|\\)|;| &quot;, &quot;&quot;, To_Zero)]
    
    ## Add HCC before every number To_Zero
    Hierarchy[, To_Zero := gsub(&quot;\\(&quot;, &quot;HCC&quot;, To_Zero)]
    Hierarchy[, To_Zero := gsub(&quot;,&quot;, &quot;,HCC&quot;, To_Zero)]

    ## Strip away extra characters in Condition variable
    Hierarchy[, Condition := str_extract(Condition, &quot;[a-zA-Z]+ *[0-9]&quot;)]

    ## Trim away white space from all columns
    Trim &lt;- function(x){str_trim(x, side = &quot;both&quot;)}
    Hierarchy &lt;- Hierarchy[, lapply(.SD, Trim)]
    
    ## Return table
    return(Hierarchy)
}</code></pre>
<p>Run the function above and assign the output to Hierarchy_Table:</p>
<pre class="r"><code>Hierarchy_Table &lt;- HCC_Table(hcc)</code></pre>
</div>
<div id="step-5-implement-hierarchy" class="section level2">
<h2>Step 5: Implement Hierarchy</h2>
<p>The last step is implementing the hierarchical structure of condition categories (output of step 4) on the “Condition_Categories” table (output of step 3), which shows patient-level diagnoses for each of the 79 condition categories.</p>
<pre class="r"><code>Hierarchy &lt;- function(Hierarchy_Table, Condition_Categories){
    
    ## Get parameters for loops (number of hierarchy conditions and number of patients)
    Hierarchy_Count &lt;- nrow(Hierarchy_Table)
    Patient_Count &lt;- nrow(Condition_Categories)
    
    ## Loop for each hierarchy condition
    for (i in 1:Hierarchy_Count){
        
        ## Get the name of the column the hierarchy condition is based on and the vector of columns to zero
        colname &lt;- Hierarchy_Table$HCC[i]
        zero_list &lt;- unlist(strsplit(Hierarchy_Table$To_Zero[i], split=&quot;,&quot;))
        
        ## Loop through all the columns to set to 0
        for (k in zero_list){
            set(Condition_Categories, which(Condition_Categories[[colname]] == 1), k, 0)
        }
        
        ## Show progress through conditions
        print(i)
    }
    
    ## Return Hierarchical Condition Categories
    return(Condition_Categories)
}</code></pre>
<p>Run the function above and assign the output to HCCs:</p>
<pre class="r"><code>HCCs &lt;- Hierarchy(Hierarchy_Table, Condition_Categories)</code></pre>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>And there you have it! For a list of patients, you’ve converted ICD9 codes into 79 chronic diseases.</p>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
